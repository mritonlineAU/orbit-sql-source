define("orbit-common/sql-source",["orbit/main","orbit/lib/assert","./memory-source","orbit/lib/objects","exports"],function(e,t,n,s,r){"use strict";var o=e["default"],i=t.assert,a=n["default"],l=s.isArray,u=(s.isObject,function(e){try{return(e?"openDatabase":"sqlitePlugin")in window&&null!==window[e?"openDatabase":"sqlitePlugin"]}catch(t){return!1}}),c=a.extend({init:function(e,t){i("sqlSource requires Orbit.Promise be defined",o.Promise),this._super.apply(this,arguments),t=t||{},this.namespace=t.namespace||"orbit",this.version=t.version||1,this.webSQLMode=t.webSQLMode||!1,this.cordovaMode=t.cordovaMode||!1,this.new_version=!1;var n=t.callback;this._db=null,this.cordovaMode?document.addEventListener("deviceready",function(){i("Your browser does not support SQL!",u(this.webSQLMode)),this._initDB(n)}.bind(this),!1):(i("Your browser does not support SQL!",u(this.webSQLMode)),this._initDB(n));var s=this;this.schema.on("modelRegistered",function(e){return new o.Promise(function(t){s._updateSchema(e,!1,function(){console.log("sql: schema.modelRegistered: loading records",e),t(s._loadTable(e))})})})},_initDB:function(e){console.log("sql: _initDB"),this.webSQLMode?this._initDBWebSQL(e):this._initDBSQLite(e)},_initDBWebSQL:function(e){if(console.log("sql: _initDBWebSQL"),this._db=openDatabase(this.namespace,"","",2097152),this.schema.models,this._db.version!=this.version)this.new_version=!0,this._db.changeVersion(this._db.version,this.version,function(e){console.log("websql: _initDB: changing db version from ",this._db.version," to ",this.version),console.log("websql: _initDB: clearing temp table"),e.executeSql("DROP TABLE IF EXISTS temp",null,function(e){e.executeSql("CREATE TABLE temp (id)",null,function(){})})}.bind(this),function(){return e?e(this._db):void 0},function(){return e?e(this._db):void 0});else if(e)return e(this._db)},_initDBSQLite:function(e){console.log("sql: _initDBSQLite"),this._db=window.sqlitePlugin.openDatabase({name:this.namespace}),this.schema.models;var t=this;this._db.transaction(function(n){n.executeSql("PRAGMA user_version",[],function(n,s){var r=s.rows.item(0).user_version;if(console.log("dbversion:",r," wanted version:",t.version),r!=t.version){if(t.new_version=!0,e)return e(t._db)}else if(e)return e(t._db)},function(e,t){console.log("pragma select error",t)},function(){})},function(e){console.log("error",e)})},_updateSchema:function(e,t,n){return this.new_version||t?(console.log("websql: schema.modelRegistered: model table needs to be cleared and updated: ",e),void(this.webSQLMode?this._updateSchemaWebSQL(e,t,n):this._updateSchemaSQLite(e,t,n))):n()},_updateSchemaWebSQL:function(e,t,n){var s=this;this._db.transaction(function(t){t.executeSql("DROP TABLE IF EXISTS "+e,null,function(t){var r=s.schema.models[e],o="CREATE TABLE "+e+" (";o+=s._escape(r.primaryKey.name)+" "+s._parseModeltype(r.primaryKey.type)+" primary key ";for(var i in r.attributes)o+=", "+s._escape(i)+" "+s._parseModeltype(r.primaryKey.type)+" ";o+=")",t.executeSql(o,null,function(){return n?n():void 0},function(e,t){console.log(t)})})})},_updateSchemaSQLite:function(e,t,n){var s=this;this._db.transaction(function(t){t.executeSql("DROP TABLE IF EXISTS "+e,null,function(t){var r=s.schema.models[e],o="CREATE TABLE "+e+" (";o+=s._escape(r.primaryKey.name)+" "+s._parseModeltype(r.primaryKey.type)+" primary key ";for(var i in r.attributes)o+=", "+s._escape(i)+" "+s._parseModeltype(r.primaryKey.type)+" ";o+=")",t.executeSql(o,null,function(e){console.log("created"),o="PRAGMA user_version = "+s.version,console.log(o),e.executeSql(o,null,function(){return console.log("version changed"),n?n():void 0},function(e,t){console.log("pragma change error",t)})},function(e,t){console.log(t)})},function(e,t){console.log("error dropping table",t)})})},_loadTable:function(){},_parseModeltype:function(e){switch(e){case"boolean":return"INTEGER";case"integer":return"INTEGER";case"number":return"NUMERIC";case"date":return"NUMERIC";case"datetime":return"NUMERIC";case"float":return"REAL";default:return"TEXT"}},_escape:function(e){return e},_getAttributeNames:function(e,t){var n=[];for(var s in this.schema.models[e].attributes)n.push(t?this._escape(s):s);return n},_parseSQLResultSetRows:function(e,t){var n={};if(!t||!t.hasOwnProperty("rows"))return n[e]=[],n;for(var s=[],r=0;r<t.rows.length;r++)s.push(t.rows.item(r));return n[e]=s,n},_parseSQLResultSetRow:function(e,t){var n=this._parseSQLResultSetRows(e,t);if(n&&!(n.length<=0))return n[0]},_generateSelectSQLObj:function(e,t,n){var s="SELECT * FROM "+this._escape(e);if(!t&&!n)return{sql:s,values:null};var r=[],o=[];if(n)if(l(n)){for(var i=[],a=0;a<n.length;a++)i.push("?"),o.push(n[a]);r.push(this._escape(this.schema.models[e].primaryKey.name)+" IN ("+i.join(",")+")")}else r.push(this._escape(this.schema.models[e].primaryKey.name)+" = ?"),o.push(n);for(var a in t)r.push(this._escape(a)+" = ?"),o.push(t[a]);return{sql:s+" WHERE "+r.join(" AND "),values:o}},_generateInsertSQLObj:function(e,t,n){n||(n=uuid());var s=this._getAttributeNames(e),r=[n],o=["?"],i=[this._escape(this.schema.models[e].primaryKey.name)];return s.forEach(function(e){i.push(e),r.push(t[e]),o.push("?")}),{sql:"INSERT OR REPLACE  INTO "+this._escape(e)+" ("+i.join(",")+") VALUES ("+o.join(",")+")",values:r}},_generateUpdateSQLObj:function(e,t,n){var s=[],r=[];for(var o in t)r.push(this._escape(o)+" = ?"),s.push(t[o]);return s.push(n),{sql:"UPDATE "+this._escape(e)+" SET "+r.join(",")+" WHERE "+this._escape(this.schema.models[e].primaryKey.name)+" = ?",values:s}},_generateDeleteSQLObj:function(e,t){return{sql:"DELETE FROM "+this._escape(e)+" WHERE "+this._escape(this.schema.models[e].primaryKey.name)+" = ?",values:[t]}},_transform:function(e){console.log("sql: _transform: ",e);var t=this,n=e.op,s=e.path;if(s.length>2){if("__rel"!==s[2])return t._transformUpdateAttribute(e);if("add"===n)return t._transformAddLink(e);if("remove"===n)return t._transformRemoveLink(e);if("replace"===n)return t._transformReplaceLink(e)}else if(s.length>1){if("add"===n)return t._transformAdd(e);if("replace"===n)return t._transformReplace(e);if("remove"===n)return t._transformRemove(e)}throw new OperationNotAllowed("sqlSource#transform could not process operation: "+e.op+" with path: "+e.path.join("/"))},_find:function(e,t){return!t||"number"!=typeof t&&"string"!=typeof t?t&&l(t)?this._findMany(e,t):this._findQuery(e,t):this._findOne(e,t)},_transformAdd:function(e){console.log("sql: _transformAdd: ",e);var t=e.path[0],n=e.path[1],s=this._generateInsertSQLObj(t,e.value,n),r=this;return this._sqlQuery(s.sql,s.values).then(function(){r.deserialize(t,null,e.value)})},_transformReplace:function(e){console.log("sql: _transformReplace: ",e);var t=e.path[0],n=e.path[1],s=(e.value,this._generateInsertSQLObj(t,e.value,n)),r=this;return this._sqlQuery(s.sql,s.values).then(function(){r.deserialize(t,null,e.value)})},_transformUpdateAttribute:function(e){console.log("sql: _transformUpdateAttribute: ",e);var t=e.path[0],n=e.path[1],s=e.path[2],r={};r[s]=e.value;var o=this._generateUpdateSQLObj(t,r,n),i=this;return this._sqlQuery(o.sql,o.values,!0).then(function(){i._transformCache(e)})},_transformRemove:function(e){console.log("sql: _transformRemove: ",e);var t=e.path[0],n=e.path[1],s=this._generateDeleteSQLObj(t,n),r=this;return this._sqlQuery(s.sql,s.values,!0).then(function(){r._transformCache({op:"remove",path:[t,n]})})},_findOne:function(e,t){console.log("sql: _findOne: ",e,t);var n=this._generateSelectSQLObj(e,null,t),s=this;return this._sqlQuery(n.sql,n.values).then(function(t){var n=s._parseSQLResultSetRows(e,t),r=s.deserialize(e,null,n);return s.settleTransforms().then(function(){return console.log("sql: _findOne: done",r[0]),r[0]})})},_findMany:function(e,t){console.log("sql: _findMany: ",e,t);var n=this._generateSelectSQLObj(e,null,t),s=this;return this._sqlQuery(n.sql,n.values).then(function(t){var n=s._parseSQLResultSetRows(e,t),r=s.deserialize(e,null,n);return s.settleTransforms().then(function(){return console.log("sql: _findMany: done",l(r)?r:[r]),l(r)?r:[r]})})},_findQuery:function(e,t){console.log("sql: _findQuery: ",e,t);var n=this._generateSelectSQLObj(e,t),s=this;return this._sqlQuery(n.sql,n.values).then(function(t){var n=s._parseSQLResultSetRows(e,t),r=s.deserialize(e,null,n);return s.settleTransforms().then(function(){return console.log("sql: _findQuery: done",r),r})})},_sqlQuery:function(e,t,n){var s=this;return new o.Promise(function(r,o){s._db.transaction(function(s){s.executeSql(e,t,function(e,t){return n&&t.rowsAffected<=0?o():void r(t)})})})},_transformCache:function(e){var t;console.log("sql: _transformCache: ",e),t="add"===e.op?e.path.slice(0,e.path.length-1):e.path,this.retrieve(t)?this._cache.transform(e):"replace"===e.op?(e.op="add",this._transformCache(e)):this.didTransform(e,[])},_addRecordsToCache:function(e,t){var n=this;console.log("sql: _addRecordsToCache: ",e,t);for(var s=0;s<t.length;s++)n._addRecordToCache(e,t[s])},_addRecordToCache:function(e,t){console.log("sql: _addRecordToCache: ",e,t),this._transformCache({op:"add",path:[e,this.getId(e,t)],value:t})},resourceNamespace:function(){return this.namespace},deserialize:function(e,t,n){if(console.log("sql: deserialize: ",e,t,n),l(n[e]))for(var s=0;s<n[e].length;s++)n[e][s]=this.schema.normalize(e,n[e][s]);var r=n[e];return console.log("sql: deserialize: primaryRecords: ",r),this._cache&&(l(r)?this._addRecordsToCache(e,r):this._addRecordToCache(e,r)),r},purge:function(e){if(!e){e=[];for(var t in this.schema.models)e.push(t)}return new o.Promise(l(e)?function(t){for(var n=0;n<e.length;n++)this._updateSchema(e[n],!0);t(e)}.bind(this):function(t){this._updateSchema(e,!0,function(){t(e)})}.bind(this))}});r["default"]=c});